# Skill: Building a Modern E-commerce with Next.js 15 & Payload CMS 3.x

This document serves as a **Skill** for AI agents and developers to replicate the construction of the Montblanc Pens e-commerce platform. It documents the **exact working stack**, critical configurations, and specific solutions to complex integration issues encountered during development.

## üèó Core Technical Stack (Final Verified State)

- **Framework**: Next.js 15.4.11 (App Router)
- **CMS**: Payload CMS 3.75.0 (Locked Version)
- **Database**: PostgreSQL (Supabase) via `@payloadcms/db-postgres`
- **Styling**: Tailwind CSS v4 (using `@tailwindcss/postcss`)
- **Deployment**: Vercel (Serverless)
- **Package Manager**: npm

---

## üöÄ Implementation Strategy (Step-by-Step)

### 1. Project Initialization & Dependencies
**Rule**: Always lock Payload versions to avoid mismatch errors.
```json
// package.json dependencies (Critical for Stability)
{
  "next": "15.4.11",
  "payload": "3.75.0",
  "@payloadcms/next": "3.75.0",
  "@payloadcms/db-postgres": "3.75.0",
  "@payloadcms/richtext-lexical": "3.75.0",
  "@payloadcms/ui": "3.75.0"
}
```
**Command**: `npm install` (Ensure clean node_modules if version mismatch occurs)

### 2. Layout Architecture (Crucial for Admin Panel)
**Pattern**: Use **Parallel Root Layouts** (No top-level `layout.tsx`).

- **`src/app/layout.tsx`**: **DELETE THIS FILE**.
  - **Reason**: A top-level layout wraps *all* routes, including the Admin panel. Since Payload's Admin panel has its own `<html>` and `<body>` tags, wrapping it causes **Nested HTML** and hydration crashes.

- **`src/app/(frontend)/layout.tsx`**:
  - Acts as the Root Layout for the public site.
  - **MUST** contain `<html>` and `<body>` tags.
  - Imports global CSS (`import '../globals.css'`).
  - Configures Fonts (`next/font/google`) and Metadata.
  - Provides `CartProvider`, `ThemeProvider`, `Navbar`, `Footer`.

- **`src/app/(payload)/layout.tsx`**:
  - Acts as the Root Layout for the Admin panel.
  - Handles its own HTML structure via `@payloadcms/next/layouts`.


### 3. Database Configuration (PostgreSQL)
**Config**: `src/payload.config.ts`
```typescript
import { postgresAdapter } from '@payloadcms/db-postgres'

export default buildConfig({
  // ...
  db: postgresAdapter({
    pool: {
      connectionString: process.env.DATABASE_URL,
    },
  }),
})
```
**Schema**: Automatically generated by Payload on first admin access.

### 4. Admin Panel & Vercel Deployment
**Critical Fix**: Do **NOT** use `@payloadcms/storage-vercel-blob` if it introduces version conflicts (e.g., v3.76.0 vs v3.75.0).
- **Alternative**: Use standard Vercel Blob SDK directly or wait for version alignment.
- **Import Map**: If `importMap.js` contains crashing client imports, manually clean them or regenerate with `npm run generate:importmap` ensuring no incompatible plugins are present.

---

## ‚ö†Ô∏è What Went Wrong & How to Avoid It

### üî¥ Issue 1: The "Nested HTML" Crash
**Symptoms**: Admin panel fails to load locally; console shows hydration mismatches.
**Cause**: Having a `layout.tsx` that renders `<html><body>...</body></html>` and then nesting Payload's Admin layout (which *also* has its own HTML structure) inside it.
**Solution**: 
1. Move the public site layout to `(frontend)/layout.tsx`.
2. Ensure `(frontend)/layout.tsx` returns a `<div>` wrapper, NOT `<body>`.
3. Keep the root `app/layout.tsx` minimal.

### üî¥ Issue 2: Payload Version Mismatch
**Symptoms**: Runtime error: `Mismatching "payload" dependency versions found`.
**Cause**: Installing a plugin (like `@payloadcms/plugin-cloud-storage`) that pulled in a newer version (3.76.0) while core Payload was at 3.75.0.
**Solution**:
1. **Lock versions**: Remove carrots (`^`) from `package.json` for all `@payloadcms/*` packages.
2. **Clean install**: `rm -rf node_modules package-lock.json && npm install`.

### üî¥ Issue 3: Admin Panel Client-Side Exception
**Symptoms**: "Application error: a client-side exception has occurred" on `/admin`.
**Cause**: The `importMap.js` file (generated by Payload) included a reference to `VercelBlobClientUploadHandler` from the incompatible storage plugin, even after the plugin was disabled.
**Solution**:
1. Remove the plugin from `payload.config.ts`.
2. Manually edit `src/app/(payload)/admin/importMap.js` to remove the offending import.
3. Restart dev server.

### üî¥ Issue 4: Database Connection Timeout
**Symptoms**: `Error: cannot connect to Postgres` during static generation.
**Cause**: Next.js tries to build static pages that require database access, but the serverless build environment (or local build) times out.
**Solution**: Force dynamic rendering for data-dependent pages.
```typescript
// src/app/(frontend)/page.tsx
export const dynamic = 'force-dynamic'
```

### üî¥ Issue 5: Runtime Regression (ENOENT _document.js)
**Symptoms**: sudden crash with `Error: ENOENT: no such file or directory, open ... .next\server\pages\_document.js` after a refactor.
**Cause**: Corrupted Next.js build cache (`.next` folder) combined with a lingering "zombie" node process locking files.
**Solution**:
1. Kill all node processes: `taskkill /F /IM node.exe` (Windows) or `pkill node` (Mac/Linux).
2. Delete the cache: `rm -rf .next`.
3. Restart server: `npm run dev`.

---

## üé® Design System (Tailwind v4)
- **Glassmorphism**: Use `backdrop-blur-md bg-white/80` for navbars and overlays.
- **Typography**: Inter (Sans) + Playfair Display (Serif) via `next/font/google`.
- **Animations**: `framer-motion` for page transitions and scroll reveals.
- **Mobile Menu**: Full-screen overlay with `AnimatePresence`.

## ‚úÖ Final Verification Checklist
1. `npm run dev` starts without warnings.
2. `/admin` loads (200 OK) and allows login.
3. `/collections` fetches data from Supabase.
4. Deployment to Vercel builds successfully.
